package adventofcode.aoc2023.day16;

import java.util.*;

public class Main2 {
    static String s =
            ".|...#....\n" +
                    "|.-.#.....\n" +
                    ".....|-...\n" +
                    "........|.\n" +
                    "..........\n" +
                    ".........#\n" +
                    "....*.##..\n" +
                    ".-.-*..|..\n" +
                    ".|....-|.#\n" +
                    "..**.|....";

    static String s1 =
            ".|...#....\n" +
                    "|.-.#.....\n" +
                    ".....|-...\n" +
                    ".#..#...|.\n" +
                    ".|..*.....\n" +
                    ".........#\n" +
                    "....*.##..\n" +
                    "...-*..|..\n" +
                    "......-|.#\n" +
                    "..**.|....";


    static String sq =
            "#......*...|..........|......*...*..-..*.|...|......-.|..................................|...............*....\n" +
                    "|....-.........#..........#.......*.....................................|.....-...........||..................\n" +
                    ".........-......|.*...........#...*-.......*.|...#.-.......................#....#.............................\n" +
                    "...............**...............#.........................#.......................#......*.........*.........#\n" +
                    "..-........................-..........................................|..............*..#...........*.........\n" +
                    "..........#....#..*...............|--......*..............-.............|...-.....#........#.........-...#-...\n" +
                    "....|...|..|..........................*..................-.............*..#-..........*|.........|...........|\n" +
                    ".........-.....#...................-.............|...............*....-....-....|..............*....#..*-.....\n" +
                    ".....#..*#........*..|........................|.......-..........................*-...|.......................\n" +
                    "..............|*................|........|..-......|....|.|.......|.-....#...*.............|.....-.......-....\n" +
                    ".-...|....................*..|......#......|.*..-.....#..*......................#.|..--.....................*.\n" +
                    "...............*..|...................-.........*...................*....|.............-..........|.|..#..*...\n" +
                    ".|...........|-.........|*....#.....#...-...-.-.-......-.....................................*.......#-.......\n" +
                    ".*.................*.................#....................*.-..................|.....................#.....#..\n" +
                    "#........-...|......|........-...................#.........................-..-.........*......*.....#........\n" +
                    "........-..*..........|........................-..-*#...#........-...*...*...-.......................*#.....-.\n" +
                    "..**|#...........*#.......-...........#....#.....-.*.|.............#.....*..#.......||.......-................\n" +
                    ".........*....#.........#-................*................................|-...#*.........|......|...........\n" +
                    "...|........#...*......#......*......#.........*....|......*.....*..|........*.-.........................#....\n" +
                    "..*.......*....|................................................................................##.......#..|.\n" +
                    ".............-.#.|..........|....................................................-..........|.................\n" +
                    "#......|.............#..-.....................................-.|...................................-|........\n" +
                    ".....................-......|#......................|...-.#......-.........-.........#............**...-......\n" +
                    "...*.....#..................|..-*....|.......#......#.........*.......*..*............................#..*....\n" +
                    "....|......*.....-...............*..........................*...................-...-.........................\n" +
                    "...................|....|.........-....*....|.......|..*|.....*....#..................*.............|.........\n" +
                    ".........*..#..-............................................#.....#......|.....*#.##..|..|*................#..\n" +
                    ".....|#......|...............*............................*..............................................*...-\n" +
                    "...............|.*..*............*.#.#..............-.*...................-.*...|.*...........................\n" +
                    "-...|.*...........*#...-...........................|....-.....................-......#..................-.....\n" +
                    "....................|..|*............-.*.....-#....|.............#.*...............*.|.................#...|..\n" +
                    "..#.|.-.#.................#...........-.........-..-.......................#.....|#.......*.....-..........#..\n" +
                    ".........|...........*............-...-...........-...-.......#.|....................-.......*...|............\n" +
                    "...|.......|.......................|...........#................#................#..............*..#..........\n" +
                    "*..........*..-..............-..................*..........#|..|..........-....#...........|-.................\n" +
                    ".......#.............-..................-#......................#...................-..........-..........|...\n" +
                    "..*.....-#...............-.....#.............-....-#*..........|.-............*...............#.............#.\n" +
                    "............*-..........*.................#.....*.........|...*....................#......|........-.........-\n" +
                    ".......|....-.....................*........*............................................*....-................\n" +
                    "...#....-................................-....#.#........................*.*.............................*....\n" +
                    ".......#.....................*......#.*.........|.......|.||....-.-.#..........-............................*.\n" +
                    "..|..........#..-............|...........|..-......................#................*|....-...................\n" +
                    ".-.........|...........-...|.....*...|..........*........|....................-.....-.........................\n" +
                    "......................*.-.....*............-......#...........-...#..*...-|.......*...........|......-||.-....\n" +
                    ".........................................................-....-......*|..........................*#....*......\n" +
                    ".........|.......|....................................-...........*.-....................-....-..........#....\n" +
                    "..|..*-.|..........|.....|-......#..-....|*........#..|.......*..#..*...#.....................*.*.|...........\n" +
                    ".-..................-..*...........#.....................-..|*....................*........#.......*..-.-....|\n" +
                    "...............................*...|...#|.........-.........*|..........-........*.......-.....-........|.....\n" +
                    ".................|-.......#........-......-*-..*............#....................#......**.-.....#.........-..\n" +
                    "............*...............-...*........|..-...........*-................#...-...........*.......##...##*....\n" +
                    "........................-..#.............#......|........|*..................*..........#.**..................\n" +
                    "...............-.............#|-..........*.|.............*.......................*..............|.*..........\n" +
                    ".......#*-.....#..|..................*.....#.....|...................|......|...................-.#...........\n" +
                    "............................................-...................................-...........-#......|.........\n" +
                    ".................*....*...|-#.......*...............|.......................-..|..........................*..*\n" +
                    ".........|...........|..................#...|........|..*...|.......|.............*..............|............\n" +
                    ".......#........................#......*.......................-..............................................\n" +
                    "|.-................#...|........|.#..................|..-.......|....-..|....|..................|.............\n" +
                    "..............-|.-...............|...........................................................*................\n" +
                    "........#....................|..........*...........#.....|......|...................||.......................\n" +
                    ".....................-...............................#...#.....-....#..................-...........#..........\n" +
                    "..............|..#..............*......-..................-....**..#|.|.#.......|.....................-.......\n" +
                    ".#...|........||............................*................#....|..................#.......#..............-.\n" +
                    ".............|...|...........*..|..............|.||..*................|......|....................-....#......\n" +
                    ".....................#.-...........#.|...|................|........-..*..............|...|....................\n" +
                    "....#.......#..............|.-#..................|........|..*.......*..-....*.........-.#...#................\n" +
                    ".............|#......|*.....-....-......#........*............|....#....#...........................-.........\n" +
                    ".........#....*................................-.................##.....|...-..........-...........|........*.\n" +
                    "..........-...................-..#...............-...#........|............#....*#...|...#..........|.........\n" +
                    "||........#.................|......#|..*...#..-...|..*..............................*.........................\n" +
                    "..................#......................-|.....#.|..........|...||.........|..........#...|..................\n" +
                    "..............*..|.............-.....#..............*........-.-......................-|.....-........|......*\n" +
                    "..........................................***.....|...-..|.-...................#-...........#......#.......*..\n" +
                    ".....|.|.........................................................-...........................*|..|-...........\n" +
                    "....*....*......-........|.......|.....#......-.*.....*.............|..............#....-.......*|.#.#.*...-#.\n" +
                    "...#..........-..|...................|............................*.....#........#............................\n" +
                    "........#..#...-................*..#...--.....................................*#.......-......*......-.....#..\n" +
                    "..-..................|...#......#..........-.|...#.................|..........#|...-..........................\n" +
                    "#.............#-...#...............*...............#...#.....................*.#.-..-#.-...|.............*...#\n" +
                    "..*...|........*...........#..................#...................|.....#..|......#.....*........-.....*......\n" +
                    "....*...........|...................*|...#.....-...-........|........*.............................|........|.\n" +
                    "...................#................--..|....................*................................................\n" +
                    ".#..#.............-*#...................................*...........|....#|.......*.........................|.\n" +
                    ".............................*...................................-.............|............-*...|............\n" +
                    ".*.............................#......................-.........#..................-...-*.............-.......\n" +
                    ".....*..........|.....|.....*.......................#.................#...........#...........................\n" +
                    "........||....................-..-........|........*.......*.-#..............*............-...................\n" +
                    "..........-....*...........|.-.............-...........................#.....|..|.-.....-...#...|.............\n" +
                    "...*.....................#.........-..|.......................*....#..#..................-....................\n" +
                    ".*...........*...............................................................-................................\n" +
                    "..-....**................*...................*....-.#.....-....#....#..........|.......................*......\n" +
                    "..........................-......#....|...........##|.........................-...#.....|.....*........#......\n" +
                    "........|...............-...#.....................*..........................*.-..........#..*.......#........\n" +
                    "........|.#.....|..#...||.............#.............*.............*.*.......#....#....................*.....|.\n" +
                    "....................*.................-..#........*................-....|.......................|.............\n" +
                    "...........|....#.......*..|...............|........|............#...*..................*..........#..........\n" +
                    ".......*...|.........*...-.|#.................................................*.................*.............\n" +
                    "...............|....#..*..-*..............|.....................#....|...............#..........*.....#.#.....\n" +
                    "#|......||.....*...*..........................*.......*.....#.*...-...............*............|.......|....#.\n" +
                    ".#.*.....................|.........-.....-....*.##..............................#.................-...........\n" +
                    "...........-........*.....|.......#.........|..-.....|.......#............*...-...-.-.|.|..|-.............|...\n" +
                    "....................#.....-.*.......*...................................-.........................|....|......\n" +
                    "..#...............|.................*............*.......#.*.....#.........-.*...-................|||...|.....\n" +
                    "......|.....|.....*....|........*.......#.*........-..-...#.-..-.-.........................|........-#........\n" +
                    "|-..................#.....-.............................|..*#..........||............|.|................|.....\n" +
                    ".................#..#.....|......................*.....-.............*|...............................--.|..-|\n" +
                    "..|.........-.-..........-.*...................*.*................-...........................#........*......\n" +
                    ".....|.*-............|.......#*.....-...-........-......................#.......|.............#..|............\n" +
                    "......|..............|............|.*...........#..-......#..#.-....*....*...*................-|....|..#......\n";

    public static void main(String[] args) {
        String[] ss = sq.split("\n");

        int max = 0;
        int k = 0;
        for (int i = 0; i < ss.length; i++) {
            for (int j = 0; j < ss[0].length(); j++) {
                System.out.println(k++);
                if (i == 0) {
                    int z = extracted(ss, new Beam(i, j, 3));
                    if (max < z) {
                        max = z;
                    }
                }
                if (j == 0) {
                    int z = extracted(ss, new Beam(i, j, 2));
                    if (max < z) {
                        max = z;
                    }
                }
                if (i == ss.length - 1) {
                    int z = extracted(ss, new Beam(i, j, 1));
                    if (max < z) {
                        max = z;
                    }
                }
                if (j == ss[0].length() - 1) {
                    int z = extracted(ss, new Beam(i, j, 4));
                    if (max < z) {
                        max = z;
                    }
                }
            }
        }
        System.out.println(max);
    }

    private static int extracted(String[] ss, Beam beamIn) {
        Stack<Beam> queue = new Stack<>();
        queue.add(beamIn);
        List<String> mat = new ArrayList<>();
        while (!queue.isEmpty()) {
            Beam beam = queue.pop();
            int i = beam.spi;
            int j = beam.spj;
            int dir = beam.dir;
            while (true) {
                if (i < 0 || j < 0 || i >= ss.length || j >= ss[0].length() || mat.contains(i + "," + j + "#" + dir)) {
                    break;
                }
//                System.out.println(i + " " + j + " " + dir);
                mat.add(i + "," + j + "#" + dir);
                // UP
                if (dir == 1) {
                    if (ss[i].charAt(j) == '.') {
                        i--;
                        continue;
                    }
                    if (ss[i].charAt(j) == '|') {
                        i--;
                        continue;
                    }
                    if (ss[i].charAt(j) == '*') { // /
                        j++;
                        dir = 2;
                        continue;
                    }
                    if (ss[i].charAt(j) == '#') { // \
                        j--;
                        dir = 4;
                        continue;
                    }
                    if (ss[i].charAt(j) == '-') {
                        if (j > 0) {
                            queue.add(new Beam(i, j - 1, 4));
                        }
                        if (j < ss[0].length() - 1) {
                            queue.add(new Beam(i, j + 1, 2));
                        }
                        break;
                    }
                } else {
                    // DOWN
                    if (dir == 3) {
                        if (ss[i].charAt(j) == '.') {
                            i++;
                            continue;
                        }
                        if (ss[i].charAt(j) == '|') {
                            i++;
                            continue;
                        }
                        if (ss[i].charAt(j) == '*') { // /
                            j--;
                            dir = 4;
                            continue;
                        }
                        if (ss[i].charAt(j) == '#') { // \
                            j++;
                            dir = 2;
                            continue;
                        }
                        if (ss[i].charAt(j) == '-') {
                            if (j > 0) {
                                queue.add(new Beam(i, j - 1, 4));
                            }
                            if (j < ss[0].length() - 1) {
                                queue.add(new Beam(i, j + 1, 2));
                            }
                            break;
                        }
                    } else {
                        // RIGHT
                        if (dir == 2) {
                            if (ss[i].charAt(j) == '.') {
                                j++;
                                continue;
                            }
                            if (ss[i].charAt(j) == '-') {
                                j++;
                                continue;
                            }
                            if (ss[i].charAt(j) == '*') { // /
                                i--;
                                dir = 1;
                                continue;
                            }
                            if (ss[i].charAt(j) == '#') { // \
                                i++;
                                dir = 3;
                                continue;
                            }
                            if (ss[i].charAt(j) == '|') {
                                if (i > 0) {
                                    queue.add(new Beam(i - 1, j, 1));
                                }
                                if (i < ss.length - 1) {
                                    queue.add(new Beam(i + 1, j, 3));
                                }
                                break;
                            }
                        } else {
                            // LEFT
                            if (ss[i].charAt(j) == '.') {
                                j--;
                                continue;
                            }
                            if (ss[i].charAt(j) == '-') {
                                j--;
                                continue;
                            }
                            if (ss[i].charAt(j) == '*') { // /
                                i++;
                                dir = 3;
                                continue;
                            }
                            if (ss[i].charAt(j) == '#') { // \
                                i--;
                                dir = 1;
                                continue;
                            }
                            if (ss[i].charAt(j) == '|') {
                                if (i > 0) {
                                    queue.add(new Beam(i - 1, j, 1));
                                }
                                if (i < ss.length - 1) {
                                    queue.add(new Beam(i + 1, j, 3));
                                }
                                break;
                            }
                        }
                    }
                }
            }
        }
        Set<String> set = new HashSet<>();
        for (int i = 0; i < mat.size(); i++) {
            set.add(mat.get(i).split("#")[0]);
        }
        return set.size();
    }

    static class Beam {
        int spi;
        int spj;
        int dir;

        public Beam(int spi, int spj, int dir) {
            this.spi = spi;
            this.spj = spj;
            this.dir = dir;
        }
    }


}
